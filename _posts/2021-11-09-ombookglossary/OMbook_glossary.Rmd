---
title: "For OMbook glossary"
author: "Chris Evans"
date: "01/11/2021"
output: html_document
---
# Explanation

This file is simply a cumulative collection of code I wrote to create graphics (or occasionally raw numbers) for entries in the glossary for our book *Outcome measures and evaluation in counselling and psychotherapy*.  

* Information about the book is at https://ombook.psyctc.org/SAGE/
* Supplementary information is at https://ombook.psyctc.org/book/ and ...
* ... the glossary itself is at https://ombook.psyctc.org/glossary/

I'm not claiming the code is good, some of it certainly isn't, but it works.  Some of it uses real data which for now I am not making available until I am sure that is safe and OK with others involved in collecting the data.

```{r setup, include=FALSE}
### set default options for the knitting of the Rmarkdown
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

# Notes to self

* Best to store theme  
* Always set xlab and ylab explicitly  
* Using ggsave helps create standard size  
* Probably correct not to bother with plot titles for simple plots

```{r setup2}
setwd("~/internalHDD/Data/MyR/R/distill_blog/test2/_posts/2021-11-09-ombookglossary")
library(tidyverse)
library(janitor)
library(pander)
library(CECPfuns)

### set theme here
theme_set(theme_bw())
theme_update(plot.title = element_text(hjust = .5),
             plot.subtitle = element_text(hjust = .5),
             axis.title = element_text(size = 15))
```

```{r}
set.seed(12345)
valN <- 350
valMean <- 14
valMin <- 0
valMax <- 40
valSD <- 7

rnorm(valN, valMean, valSD) %>%
  as_tibble() %>%
  mutate(score = round(value),
         score = if_else(score < 0, 0, score),
         score = if_else(score > 40, 40, score)) -> tibDat

tibDat %>%
  summarise(min = min(score),
            lQuart = quantile(score, .25),
            mean = mean(score),
            median = median(score),
            uQuart = quantile(score, .75),
            max = max(score),
            SD = sd(score)) -> tibSummary


ggplot(data = tibDat,
       aes(x = score)) + 
  geom_histogram(center = TRUE) +
  geom_vline(xintercept = tibSummary$mean, 
             colour = "blue",
             size = 2) +
    geom_vline(xintercept = tibSummary$median, 
             colour = "green",
             size = 2) +
  scale_x_continuous(breaks = seq(0, 40, 2)) +
  xlab("Score") +
  ylab("Count") 


ggsave(filename = "mean.png",
       width = 1700,
       height = 1470,
       units = "px")

```


```{r mean2}
tibDat %>%
  mutate(score2 = score^1.9) -> tibDat

max(tibDat$score2)
mean(tibDat$score2)
median(tibDat$score2)
ggplot(data = tibDat,
       aes(x = score2)) + 
  geom_histogram(center = TRUE) +
  geom_vline(xintercept = mean(tibDat$score2), 
             colour = "blue",
             size = 2) +
  geom_vline(xintercept = median(tibDat$score2), 
             colour = "green",
             size = 2) +
  scale_x_continuous(breaks = seq(0, 800, 50)) +
  xlab("Score") +
  ylab("Count") 

ggsave(filename = "mean2.png",
       width = 1700,
       height = 1470,
       units = "px")
```

```{r skew1}
set.seed(12345)
valN <- 1750
valMean <- 14

rnorm(valN) %>%
  as_tibble() %>%
  rename(score = value) -> tibSymm


ggplot(data = tibSymm,
       aes(x = score)) + 
  geom_histogram(center = TRUE) +
  xlab("Score") +
  ylab("Count") 

ggsave(filename = "symm.png",
       width = 1700,
       height = 1470,
       units = "px")

standardiseVar <- function(x){
  x <- x - mean(x, na.rm = TRUE)
  x / sd(x, na.rm = TRUE)
}
tibSymm %>%
  mutate(score2 = (5 + score)^3,
         score2 = standardiseVar(score2)) -> tibSymm

ggplot(data = tibSymm,
       aes(x = score2)) + 
  geom_histogram(center = TRUE) +
  xlab("Score") +
  ylab("Count") 

ggsave(filename = "posSkew.png",
       width = 1700,
       height = 1470,
       units = "px")


tibSymm %>%
  mutate(score3 = log(5 + score),
         score3 = standardiseVar(score3)) -> tibSymm

ggplot(data = tibSymm,
       aes(x = score3)) + 
  geom_histogram(center = TRUE) +
  xlab("Score") +
  ylab("Count") 

ggsave(filename = "negSkew.png",
       width = 1700,
       height = 1470,
       units = "px")
```

```{r quartiles1}
ggplot(data = tibDat,
       aes(x = score)) + 
  geom_histogram(center = TRUE) +
  geom_vline(xintercept = tibSummary$mean, 
             colour = "blue",
             size = 2) +
    geom_vline(xintercept = tibSummary$median, 
             colour = "green",
             size = 2) +
  scale_x_continuous(breaks = seq(0, 40, 2)) +
  xlab("Score") +
  ylab("Count") 

tibDat %>%
  rename(symm = score,
         skew = score2) %>%
  pivot_longer(cols = symm:skew, names_to = "dist", values_to = "score") -> tibDatLong

tibDatLong %>%
  group_by(dist) %>%
  summarise(min = min(score),
            lQuart = quantile(score, .25),
            mean = mean(score),
            median = median(score),
            uQuart = quantile(score, .75),
            max = max(score),
            SD = sd(score)) -> tibSummary2

tibSummary2 %>%
  select(dist, ends_with("Quart")) %>%
  pivot_longer(cols = ends_with("Quart")) -> tibIQR


ggplot(data = tibDatLong,
       aes(x = score)) + 
  geom_histogram(center = TRUE) +
  geom_vline(data = tibSummary2,
             aes(xintercept = median),
             colour = "green",
             size = 2) +
  geom_vline(data = tibSummary2,
             aes(xintercept = mean),
             colour = "red",
             size = 1) +
  geom_vline(data = tibSummary2,
             aes(xintercept = lQuart),
             colour = "blue",
             size = 2) +
  geom_vline(data = tibSummary2,
             aes(xintercept = uQuart),
             colour = "blue",
             size = 2) +
  geom_line(data = tibIQR,
            aes(y = 5, x = value),
            arrow = arrow(ends = "both"),
            colour = "blue",
            size = 1.2) +
  facet_wrap(facets = vars(dist),
             nrow = 2,
             scales = "free") +
  xlab("Score") +
  ylab("Count") 

ggsave(filename = "IQR.png",
       width = 1700,
       height = 1470,
       units = "px")

tibSummary2 %>%
  filter(dist == "symm") -> tibSummary2symm
tibIQR %>%
  filter(dist == "symm") -> tibIQRsymm

ggplot(data = filter(tibDatLong, dist == "symm"),
       aes(x = score)) + 
  geom_histogram(center = TRUE) +
  geom_vline(data = tibSummary2symm,
             aes(xintercept = median),
             colour = "green",
             size = 2) +
  geom_vline(data = tibSummary2symm,
             aes(xintercept = mean),
             colour = "red",
             size = 1) +
  geom_vline(data = tibSummary2symm,
             aes(xintercept = lQuart),
             colour = "blue",
             size = 2) +
  geom_vline(data = tibSummary2symm,
             aes(xintercept = uQuart),
             colour = "blue",
             size = 2) +
  geom_line(data = tibIQRsymm,
            aes(y = 5, x = value),
            arrow = arrow(ends = "both"),
            colour = "blue",
            size = 1.2) +
  xlab("Score") +
  ylab("Count") 

ggsave(filename = "IQRsymm.png",
       width = 1700,
       height = 1470,
       units = "px")


tibSummary2 %>%
  filter(dist == "skew") -> tibSummary2skew
tibIQR %>%
  filter(dist == "skew") -> tibIQRskew

ggplot(data = filter(tibDatLong, dist == "skew"),
       aes(x = score)) + 
  geom_histogram(center = TRUE) +
  geom_vline(data = tibSummary2skew,
             aes(xintercept = median),
             colour = "green",
             size = 2) +
  geom_vline(data = tibSummary2skew,
             aes(xintercept = mean),
             colour = "red",
             size = 1) +
  geom_vline(data = tibSummary2skew,
             aes(xintercept = lQuart),
             colour = "blue",
             size = 2) +
  geom_vline(data = tibSummary2skew,
             aes(xintercept = uQuart),
             colour = "blue",
             size = 2) +
  geom_line(data = tibIQRskew,
            aes(y = 5, x = value),
            arrow = arrow(ends = "both"),
            colour = "blue",
            size = 1.2) +
  xlab("Score") +
  ylab("Count") 

ggsave(filename = "IQRskew.png",
       width = 1700,
       height = 1470,
       units = "px")
```


```{r quartiles2}
valN <- 300
set.seed(12345)

rnorm(valN, 40, 5) %>%
  as_tibble() %>%
  rename(score = value) -> tibDat1

ggplot(data = tibDat1,
       aes(x = score)) +
  geom_histogram(center = TRUE) +
  geom_vline(xintercept = mean(tibDat1$score),
             colour = "blue",
             size = 2) +
  geom_vline(xintercept = quantile(tibDat1$score, c(.25, .75)),
             colour = "green",
             size = 2) +
  xlab("Score") +
  ylab("Count") +
  scale_x_continuous(breaks = seq(0, 100, 10),
                     limits = c(0, 100))

ggsave(filename = "quartiles1.png",
       width = 1700,
       height = 1470,
       units = "px")

mean(tibDat1$score)
quantile(tibDat1$score, c(.25, .75))

rnorm(valN, 40, 15) %>%
  as_tibble() %>%
  rename(score = value) -> tibDat1

ggplot(data = tibDat1,
       aes(x = score)) +
  geom_histogram(center = TRUE) +
  geom_vline(xintercept = mean(tibDat1$score),
             colour = "blue",
             size = 2) +
  geom_vline(xintercept = quantile(tibDat1$score, c(.25, .75)),
             colour = "green",
             size = 2) +
  xlab("Score") +
  ylab("Count") +
  scale_x_continuous(breaks = seq(0, 100, 10),
                     limits = c(0, 100))

ggsave(filename = "quartiles2.png",
       width = 1700,
       height = 1470,
       units = "px")

mean(tibDat1$score)
quantile(tibDat1$score, c(.25, .75))

```


```{r uniformDist}
set.seed(12345)
c(6, 6, 6, 6, 12, 18, 24, 50, 100, 200, 500, 1000, 1000, 5000, 10000) %>%
  as_tibble() %>%
  rename(sampSize = value) %>%
  mutate(sampID = row_number()) %>%
  # group_by(sampID) %>%
  # uncount(weights = sampSize, .id  = "indID")
  rowwise() %>%
  mutate(values = list(sample(1:6, sampSize, replace = TRUE))) %>%
  ungroup() %>%
  unnest_longer(values) -> tibUnif

# tibUnif

ggplot(data = filter(tibUnif, sampSize == 6),
       aes(x = values)) +
  # geom_histogram(binwidth = 1,
  #                boundary = 0) +
  geom_bar() +
  facet_grid(rows = vars(sampID),
             cols = NULL,
             scales = "free_y") +
  scale_y_continuous(breaks = 0:2) +
  scale_x_continuous(name = "Observed scores on each die", breaks = 1:6)

ggsave(filename = "dice1.png",
       width = 1700,
       height = 1470,
       units = "px")

tibUnif %>%
  filter(sampSize > 6 & sampSize < 200) -> tmpTib

ggplot(data = tmpTib,
       aes(x = values)) +
  geom_bar(aes(y = ..prop..)) +
  facet_grid(rows = vars(sampSize),
             cols = NULL,
             scales = "fixed") +
  scale_x_continuous(name = "Observed scores on each die", breaks = 1:6) +
  scale_y_continuous(name = "Proportion", breaks = (0:5)/10)

ggsave(filename = "dice2.png",
       width = 1700,
       height = 1470,
       units = "px")

tibUnif %>%
  filter(sampSize > 200) -> tmpTib

ggplot(data = tmpTib,
       aes(x = values)) +
  geom_bar(aes(y = ..prop..)) +
  facet_grid(rows = vars(sampSize),
             cols = NULL,
             scales = "fixed") +
  scale_x_continuous(name = "Observed scores on each die", breaks = 1:6) +
  scale_y_continuous(name = "Proportion", breaks = (0:5)/10)

ggsave(filename = "dice3.png",
       width = 1700,
       height = 1470,
       units = "px")
```



```{r Gaussian1}
seq(-5, 5, length = 5001) %>%
  as_tibble() %>%
  mutate(p = dnorm(value)) -> tibGauss1

ggplot(data = tibGauss1,
       aes(x = value, y = p)) +
  geom_line() +
  xlab("Observed value") +
  ylab("Probability")

ggsave(filename = "Gauss1.png",
       width = 1700,
       height = 1470,
       units = "px")
```

```{r throwingDice}
throwDice <- function(nThrows, nSides = 6, scoreSides = 1:6){
  ### function to simulate throwing dice (or anything really)
  ### defaults to six sided die with scores 1:6 but you can override that
  if(nThrows <= 0) {
    stop("nThrows must be positive")
  }
  if(nThrows > 8) {
    stop("nThrows must be under 9 (to keep things easy!)")
  }
  if(nThrows - round(nThrows) > .Machine$double.eps) {
    warning("nThrows wasn't integer, rounded to integer")
    nThrows <- round(nThrows)
  }
  newScores <- scoreSides
  while(nThrows > 1) {
    newScores <- as.vector(outer(newScores, scoreSides, FUN = "+"))
    nThrows <- nThrows - 1
  }
  newScores
}
# throwDice(0)
# throwDice(1)
# throwDice(1.1)
# throwDice(11)
# throwDice(2)
# length(throwDice(2))
# min(throwDice(2))
# max(throwDice(2))
# nThrows <- 3
# throwDice(nThrows)
# length(throwDice(nThrows))
# min(throwDice(nThrows))
# max(throwDice(nThrows))
# nThrows <- 4
# throwDice(nThrows)
# length(throwDice(nThrows))
# min(throwDice(nThrows))
# max(throwDice(nThrows))


1:8 %>%
  as_tibble() %>%
  rename(nThrows = value) %>%
  rowwise() %>%
  mutate(score = list(throwDice(nThrows)),
         nThrowsFac = factor(nThrows)) %>%
  ungroup() %>%
  unnest_longer(score) %>%
  group_by(nThrowsFac) %>%
  mutate(nScores = n()) %>%
  ungroup() %>%
  group_by(nThrowsFac, score) %>%
  summarise(nThrows = first(nThrows),
            nScores = first(nScores),
            n = n(),
            p = n / nScores) %>%
  ungroup() -> tibDiceThrows

ggplot(data = tibDiceThrows,
       aes(x = score, y = p, colour = nThrowsFac)) +
  geom_point()  +
  geom_line() +
  ylab("Probability") +
  scale_x_continuous(name = paste0("Total score from n dice (with n from 1 to ",
                                   max(tibDiceThrows$nThrows),
                                   ")"),
                     breaks = seq(2, max(tibDiceThrows$score), 2)) +
  scale_colour_discrete(name = "n(throws)") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))
  
ggsave(filename = "throwingDice.png",
       width = 1700,
       height = 1470,
       units = "px")

tibDiceThrows %>% 
  filter(nThrows == 6) -> tmpTib

tmpTib %>%
  summarise(n = n(),
            minScore = min(score),
            meanScore = Hmisc::wtd.mean(score, weights = nScores),
            maxScore = max(score),
            SDScore = sqrt(Hmisc::wtd.var(score, weights = nScores)),
            totP = sum(p)) -> tmpTibSumm

tmpTib %>%
  mutate(normScore = score - tmpTibSumm$meanScore,
         normScore = normScore / 3,
         normProb = dnorm(normScore) / 3) -> tmpTib
tmpTib %>%
  summarise(meanNormScore = mean(normScore),
            SDNormScore = sd(normScore),
            sumNormProb = sum(normProb))

ggplot(data = tmpTib,
       aes(x = score, y = p)) +
  geom_point()  +
  geom_line() +
  ylab("Probability") +
  scale_x_continuous(name = "Total score from 6 dice",
                     breaks = 6:36)

ggsave(filename = "throwing6Dice.png",
       width = 1700,
       height = 1470,
       units = "px")



ggplot(data = tmpTib,
       aes(x = score, y = p)) +
  geom_point()  +
  geom_line() +
  geom_point(aes(y = normProb), 
            colour = "green") +
  geom_line(aes(y = normProb), 
            colour = "green") +    
  ylab("Probability") +
  scale_x_continuous(name = "Total score from 6 dice",
                     breaks = 2:max(tmpTib$score)) +
  scale_colour_discrete(name = "n(throws)")
  
ggsave(filename = "throwing6DiceWithGaussian.png",
       width = 1700,
       height = 1470,
       units = "px")



ggplot(data = tmpTib,
       aes(x = score, y = p)) +
  geom_point()  +
  geom_line() +
  ylab("Probability") +
  scale_x_continuous(name = "Total score from 6 dice",
                     breaks = 2:max(tmpTib$score)) +
  scale_colour_discrete(name = "n(throws)")
  
ggsave(filename = "throwing6Dice.png",
       width = 1700,
       height = 1470,
       units = "px")

```

```{r binom1}
set.seed(12345)
nReps <- 50000
c(1:5, seq(10, 50, 10), 100, 200, 300, 400, 500) %>%
  as_tibble() %>%
  rename(nThrows = value) %>%
  rowwise() %>%
  mutate(score = list(rbinom(nReps, nThrows, .5))) %>%
  ungroup() %>%
  unnest_longer(score) %>%
  group_by(nThrows, score) %>%
  summarise(n = n(),
            p = n / nReps,
            nThrowsFac = factor(nThrows)) %>%
  ungroup() %>%
  group_by(nThrows) %>%
  mutate(scaledScore = scale(score)) -> tibBinom


ggplot(data = tibBinom,
       aes(x = score, y = p, colour = nThrowsFac)) +
  geom_point() +
  geom_line()

ggsave(filename = "tossingCoins1.png",
       width = 1700,
       height = 1470,
       units = "px")


ggplot(data = tibBinom,
       aes(x = scaledScore, y = p, colour = nThrowsFac)) +
  geom_point() +
  geom_line()

ggsave(filename = "tossingCoinsScaled.png",
       width = 1700,
       height = 1470,
       units = "px")


pbinom(0:2, 2, .5)

c(1:5, 10, 20, 50, 100) %>%
  as_tibble() %>%
  rename(nThrows = value) %>%
  rowwise() %>%
  mutate(pVals = list(pbinom(0:nThrows, nThrows, .5))) %>%
  ungroup() %>%
  unnest_longer(pVals) %>%
  group_by(nThrows) %>%
  mutate(score = row_number() - 1,
         nThrowsFac = factor(first(nThrows)),
         p = if_else(row_number() == 1, pVals, pVals - lag(pVals)),
         meanScore = Hmisc::wtd.mean(score, weights = p),
         sdScore = sqrt(Hmisc::wtd.var(score, weights = p, normwt = TRUE)),
         stdScore = (score - meanScore) / sdScore) -> tibpBinom


# tibGauss1 %>%
#   summarise(max(p)) # .399
# 
# tibpBinom %>%
#   filter(nThrows == 100) %>%
#   summarise(max(p)) # .0796

ggplot(data = tibpBinom,
       aes(x = stdScore, y = p, colour = nThrowsFac)) +
  geom_point() +
  geom_line() +
  geom_line(inherit.aes = FALSE,
            data = tibGauss1,
            aes(x = value, y = p * .0796 / .399)) +
  ylab("Probability") +
  xlab("Standardised score across tossing n fair coins, heads = 1, tails = 0") +
  scale_colour_discrete(name = "n(throws)")

ggsave(filename = "pbinomWithGauss.png",
       width = 1700,
       height = 1470,
       units = "px")
```

```{r Gaussian2}
seq(0, 20, length = 5001) %>%
  as_tibble() %>%
  mutate(NHS = dnorm(value, 8, 2),
         HS = dnorm(value, 12, 1)) %>% 
  pivot_longer(cols = ends_with("HS"), names_to = "Population", values_to = "p") -> tibGauss2

ggplot(data = tibGauss2,
       aes(x = value, y = p, colour = Population)) +
  geom_line(size = 2, alpha = .8) +
  xlab("Observed score") +
  ylab("Probability")

ggsave(filename = "Gauss2.png",
       width = 1700,
       height = 1470,
       units = "px")
```

```{r variance1}
tmpDatDir <- "~/internalHDD/Data/CORE/translations/SPA_other/Clara/Our_papers/NClinPaper"
readxl::read_excel(paste0(tmpDatDir, "/", "Muestra_NoClinica_CP180520.xlsx")) %>%
  mutate(Gender = recode(Genero,
                         Masculino = "Male",
                         Femenino = "Female")) -> tibRawDat

meanNotNA <- function(x){
  mean(x, na.rm = TRUE)
}
medianNotNA <- function(x){
  median(x, na.rm = TRUE)
}
varNotNA <- function(x){
  var(x, na.rm = TRUE)
}
sdNotNA <- function(x){
  sd(x, na.rm = TRUE)
}
minNotNA <- function(x){
  min(x, na.rm = TRUE)
}
maxNotNA <- function(x){
  max(x, na.rm = TRUE)
}

# tibRawDat %>% 
#   select(starts_with("COREOM01")) %>%
#   corrr::correlate(diagonal = 1) %>%
#   pivot_longer(cols = -term) %>%
#   filter(term != name) %>%
#   arrange(desc(value))
### OK, all recoded

tibRawDat %>%
  filter(Excluded == "NO" & !is.na(Genero)) -> tibUseDat

tibUseDat %>%
  select(Gender, Edad, starts_with("COREOM01")) %>%
  select(-COREOM01_35) %>%
  pivot_longer(cols = starts_with("COREOM01"), names_to = "Item", values_to = "Score") %>%
  # group_by(Gender, Item) %>%
  group_by(Item) %>%
  summarise(totN = n(),
            nOK = getNOK(Score),
            min = minNotNA(Score),
            mean = meanNotNA(Score),
            median = medianNotNA(Score),
            max = maxNotNA(Score),                                      
            var = varNotNA(Score),
            sd = sdNotNA(Score)) %>%
  ungroup() %>%
  # filter(min != 0 | max != 4) ## OK full range on all items
  arrange(var) %>%
  filter(row_number() %in% c(1,2,3, 32, 33, 34)) -> tmpTibSummary

tmpTibSummary %>%
  select(Item) %>% 
  pull() -> tmpVecItems

c("R: plans to end my life",
  "R: hurt myself physically...",
  "R: threatened or intimidated",
  "P: difficulty getting to sleep ...",
  "P: thought to blame ...",
  "P: felt unhappy") -> tmpVecNames

tibUseDat %>%
  select(all_of(tmpVecItems)) -> tmpTibRawScores

tmpTibRawScores %>%
  pivot_longer(cols = everything(), names_to = "Item", values_to = "Score") %>%
  filter(!is.na(Score)) %>%
  mutate(Item = ordered(Item,
                        levels = tmpVecItems,
                        labels = tmpVecNames)) -> tmpTibLongScores

tmpTibSummary %>%
  mutate(Item = ordered(Item,
                        levels = tmpVecItems,
                        labels = tmpVecNames),
         meanMinusSD = mean - sd,
         meanPlusSD = mean + sd) -> tmpTibSummary



ggplot(data = tmpTibLongScores,
       aes(x = Score)) +
  ylim(0, 1000) +
  geom_bar(width = 1) +
  geom_vline(data = tmpTibSummary,
             aes(xintercept = mean),
             colour = "green") +
  facet_wrap(facets = vars(Item), ncol = 3)

ggsave(filename = "Variance1.png",
       width = 1700,
       height = 1470,
       units = "px")


ggplot(data = tmpTibLongScores,
       aes(x = Score)) +
  ylim(0, 1000) +
  geom_bar(width = 1) +
  geom_vline(data = tmpTibSummary,
             aes(xintercept = mean),
             colour = "green") +
  geom_segment(inherit.aes = FALSE,
               data = tmpTibSummary,
               aes(y = 900, yend = 900,
                   x = meanMinusSD,
                   xend = meanPlusSD),
               colour = "blue",
               lineend = "round",
               arrow = arrow(ends = "both",
                             length = unit(2, "mm"))) +
  geom_text(data = tmpTibSummary,
            aes(y = 960, x = 4.5, label = paste0("Mean: ", 
                                                 round(mean, 2),
                                                 "\nVar: ",
                                                 round(var, 2),
                                                 "\nSD: ",
                                                 round(sd, 2))),
            size = 2.5,
            hjust = 1,
            vjust = 1) +
  facet_wrap(facets = vars(Item), ncol = 3)

ggsave(filename = "Variance2.png",
       width = 1700,
       height = 1470,
       units = "px")
```

```{r histogram1}
ggplot(data = tibRawDat,
       aes(x = Gender)) +
  geom_bar() +
  xlab("Gender") +
  theme(axis.text = element_text(size = 40),
        axis.title = element_text(size = 50)) -> ggGender1

ggplot(data = tibRawDat,
       aes(x = Edad)) +
  geom_histogram(center = TRUE,
                 breaks = 18:80) +
  xlab("Age") +
  theme(axis.text = element_text(size = 40),
        axis.title = element_text(size = 50)) -> ggAge1

ggpubr::ggarrange(ggGender1, ggAge1) -> ggArrange1

ggpubr::ggexport(ggArrange1,
         filename = "Histogram1.png",
         width = 1700,
         height = 1470,
         units = "px")

ggplot(data = tibRawDat,
       aes(x = Edad)) +
  geom_histogram(center = TRUE,
                 breaks = c(18, 20, 30, 40, 50, 80),
                 closed = "right") +
  xlab("Age") +
  scale_x_continuous(breaks = seq(10, 80, 10))
  # theme(axis.text = element_text(size = 40),
  #       axis.title = element_text(size = 50))

ggsave(filename = "HistAge.png",
       width = 1700,
       height = 1470,
       units = "px")

ggplot(data = tibRawDat,
       aes(x = Edad)) +
  geom_histogram(aes(y = stat(count) / sum(count)),
                 center = TRUE,
                 breaks = c(18, 20, 30, 40, 50, 80),
                 closed = "right") +
  xlab("Age") +
  ylab("Proportion") +
  scale_x_continuous(breaks = seq(10, 80, 10))
  # theme(axis.text = element_text(size = 40),
  #       axis.title = element_text(size = 50))

ggsave(filename = "HistAge2.png",
       width = 1700,
       height = 1470,
       units = "px")

ggplot(data = tibRawDat,
       aes(x = Edad, fill = Gender)) +
  geom_histogram(aes(y = stat(count) / sum(count)),
                 position = "dodge2",
                 center = TRUE,
                 breaks = c(18, seq(20, 80, 10)),
                 closed = "left") +
  xlab("Age") +
  ylab("Proportion") +
  scale_x_continuous(breaks = seq(20, 80, 5))

ggsave(filename = "HistAgeGendDodge.png",
       width = 1700,
       height = 1470,
       units = "px")


ggplot(data = tibRawDat,
       aes(x = Edad, fill = Gender)) +
  geom_histogram(aes(y = stat(count) / sum(count)),
                 position = "stack",
                 center = TRUE,
                 breaks = c(18, seq(20, 80, 10)),
                 closed = "left") +
  xlab("Age") +
  ylab("Proportion") +
  scale_x_continuous(breaks = seq(20, 80, 5))

ggsave(filename = "HistAgeGendStack.png",
       width = 1700,
       height = 1470,
       units = "px")


tibRawDat %>%
  filter(!is.na(Edad)) %>%
  mutate(Age = case_when(Edad < 20 ~ "<20",
                         Edad < 30 ~ "20 to 29",
                         Edad < 40 ~ "30 to 39",
                         Edad < 50 ~ "40 to 49",
                         Edad >= 50 ~ "50 and over"),
         Age = ordered(Age, 
                       levels = c("<20",
                                  "20 to 29",
                                  "30 to 39",
                                  "40 to 49",
                                  "50 and over"))) -> tmpTib #%>% select(Edad, Age)

tmpTib %>%
  tabyl(Age) %>%
  adorn_pct_formatting(digits = 1) %>%
  pander(justify = "lrr")
  
  

ggplot(data = tmpTib,
       aes(x = Age)) +
  geom_bar() +
  xlab("Age") 

ggsave(filename = "BarAge.png",
       width = 1700,
       height = 1470,
       units = "px")

```


```{r boxplot}
set.seed(12345)
tmpValN <- 10000
rnorm(tmpValN) %>% 
  as_tibble() -> tmpTibGaussian

tmpTibGaussian %>%
  summarise(min = min(value),
            lwrQ = quantile(value, .25),
            median = median(value),
            uprQ = quantile(value, .75),
            max = max(value))

ggplot(data = tmpTibGaussian,
       aes(y = value)) +
  geom_boxplot(fill = "grey") +
  ylim(4, 4) +
  xlab("") -> ggGaussBox1

ggGaussBox1

ggsave(filename = "GaussBox1.png",
       width = 1700,
       height = 1470,
       units = "px")

ggplot(data = tmpTibGaussian,
       aes(y = value)) +
  geom_boxplot(fill = "grey") +
  ylim(-4, 4) +
  xlab("") +
  theme(axis.text = element_text(size = 40),
        axis.title = element_text(size = 50)) -> ggGaussBox2

ggGaussBox2

ggplot(data = tmpTibGaussian,
       aes(x = value)) +
  geom_histogram(aes(y = ..density..),
                 fill = "grey") +
  geom_vline(xintercept = median(tmpTibGaussian$value)) +
  geom_line(data = tibGauss1,
            aes(x = value, y = p)) +
  ylab("Probability") -> ggGaussHistOnX

ggGaussHistOnX

ggsave(filename = "GaussHistOnX.png",
       width = 1700,
       height = 1470,
       units = "px")

ggplot(data = tmpTibGaussian,
       aes(y = value)) +
  geom_histogram(aes(x = ..density..),
                 fill = "grey") +
  geom_hline(yintercept = median(tmpTibGaussian$value)) +
  geom_line(data = tibGauss1,
            aes(y = value, x = p),
            orientation = "y") +
  ylim(-4, 4) +
  xlab("") +
  ylab("") +
  theme(axis.text = element_text(size = 40),
        axis.title = element_text(size = 50)) -> ggGaussHistOnY

ggGaussHistOnY

ggpubr::ggarrange(ggGaussBox2, ggGaussHistOnY,
                  ncol = 2) -> ggArrange2

ggArrange2

ggpubr::ggexport(ggArrange2,
         filename = "BoxAndHist.png",
         width = 1700,
         height = 1470,
         units = "px")
```

```{r boxplot2}
ggplot(data = tibRawDat,
       aes(y = Edad, x = Gender, fill = Gender)) +
  geom_boxplot(varwidth = TRUE) +
  ylab("Age")

ggsave(filename = "AgeByGenderBox.png",
       width = 1700,
       height = 1470,
       units = "px")

tibRawDat %>%
  mutate(SocState = `Estado civil`,
         SocState = recode(SocState,
                           `Casado/a` = "Coupled",
                           `Soltero`  = "Single",
                           `Separado/a` = "Separated",
                           `Divorciado/a` = "Divorced",
                           `Unido/a` = "Coupled",
                           `Unido` = "Coupled",
                           `Viudo/a` = "Widowed/Widower")) %>%
  rowwise() %>%
  mutate(meanCOREOM = meanNotNA(c_across(COREOM01_01:COREOM01_34))) %>%
  ungroup() -> tibRawDat

tibRawDat %>%
  mutate(SocStatNA = if_else(is.na(SocState), "NA", SocState)) %>%
  group_by(SocStatNA) %>%
  summarise(tmpN = n(),
            tmpMedianAge = median(Edad, na.rm = TRUE),
            varAge = var(Edad, na.rm = TRUE),
            SDAge = sqrt(varAge)) -> tmpTib

tmpTib %>%
  arrange(desc(tmpN)) %>%
  select(SocStatNA) %>%
  pull() -> tmpVecN

tmpTib %>%
  arrange(tmpMedianAge) %>%
  select(SocStatNA) %>%
  pull() -> tmpVecAge


tibRawDat %>%
  mutate(SocStatNA = if_else(is.na(SocState), "NA", SocState),
         SocStatN = ordered(SocStatNA,
                            levels = tmpVecN,
                            labels = tmpVecN),
         SocStateAge = ordered(SocStatNA,
                               levels = tmpVecAge,
                               labels = tmpVecAge)) -> tibRawDat

ggplot(data = tibRawDat,
       aes(y = Edad, x = SocStatN, fill = SocStatN)) +
  geom_boxplot(varwidth = TRUE) +
  geom_text(data = tmpTib,
            inherit.aes = FALSE,
            aes(x = SocStatNA, y = 12, label = tmpN),
            vjust = .5) +
  geom_text(x = .5, y = 12, label = "n: ",
            vjust = .5,
            hjust = 0) +
  ylim(10, 80) +
  scale_fill_discrete(name = "Social status") +
  ylab("Age") +
  xlab("Social status") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))

ggsave(filename = "AgeBySocStatnBox.png",
       width = 1700,
       height = 1470,
       units = "px")

ggplot(data = tibRawDat,
       aes(y = meanCOREOM, x = SocStatN, fill = SocStatN)) +
  geom_boxplot(varwidth = TRUE) +
  geom_text(data = tmpTib,
            inherit.aes = FALSE,
            aes(x = SocStatNA, y = -.2, label = tmpN),
            vjust = .5) +
  geom_text(x = .5, y = -.2, label = "n: ",
            vjust = .5,
            hjust = 0) +
  ylim(-.5, 4) +
  scale_fill_discrete(name = "Social status") +
  ylab("CORE-OM score (mean item score)") +
  xlab("Social status") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))

ggsave(filename = "COREOMBySocStatnBox.png",
       width = 1700,
       height = 1470,
       units = "px")

tibRawDat %>%
  filter(!is.na(`Tiene Hijos`)) %>%
  mutate(nChildren = `Especifique cuántos`,
         nChildren = if_else(nChildren > 3, 4, nChildren),
         nChildren = if_else(`Tiene Hijos` == "NO", 0, nChildren),
         nChildren = ordered(nChildren,
                             levels = 0:4,
                             labels = c(as.character(0:3),
                                        "4 or more"))) %>%  
  filter(!is.na(nChildren)) -> tmpTib

ggplot(data = tmpTib,
       aes(y = Edad, x = nChildren, fill = nChildren)) +
  geom_boxplot(varwidth = TRUE) 

tmpTib %>%
  rowwise() %>%
  mutate(meanCOREOM = meanNotNA(c_across(COREOM01_01:COREOM01_34))) %>%
  ungroup() -> tmpTib

ggplot(data = tmpTib,
       aes(y = meanCOREOM, x = nChildren, fill = nChildren)) +
  geom_boxplot(varwidth = TRUE) 
```

```{r notchedBoxplot1}

tmpTibGaussian %>%
  filter(row_number() <= 500) %>%
  mutate(samp250 = if_else(row_number() <= 250, value, NA_real_),
         samp100 = if_else(row_number() <= 100, value, NA_real_),
         samp50 = if_else(row_number() <= 50, value, NA_real_),
         samp10 = if_else(row_number() <= 10, value, NA_real_)) %>%
  rename(samp500 = value) -> tmpTib

tmpTib %>%
  pivot_longer(cols = everything(), names_to = "sample") %>%
  mutate(sample = ordered(sample,
                          levels = paste0("samp", c(500, 250, 100, 50, 10)))) -> tmpTibLong

ggplot(data = tmpTib,
       aes(y = samp250)) +
  geom_boxplot(fill = "grey", varwidth = TRUE, notch = TRUE) +
  ylim(-4, 4) +
  xlab("") +
  ylab("value") +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) 

ggsave(filename = "notchedGaussianBox1.png",
       width = 1700,
       height = 1470,
       units = "px")

ggplot(data = tmpTib,
       aes(y = samp250)) +
  geom_boxplot(fill = "grey", varwidth = TRUE) +
  ylim(-4, 4) +
  xlab("") +
  ylab("value") +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) 

ggsave(filename = "notNotchedGaussianBox1.png",
       width = 1700,
       height = 1470,
       units = "px")

ggplot(data = tmpTibLong,
       aes(y = value)) +
  geom_boxplot(fill = "grey", varwidth = TRUE, notch = TRUE) +
  geom_hline(yintercept = 0) +
  ylim(-4, 4) +
  facet_grid(cols = vars(sample)) +
  xlab("") +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) 

ggsave(filename = "notchedGaussianBoxes2.png",
       width = 1700,
       height = 1470,
       units = "px")

tmpTibGaussian %>%
  mutate(simulN = row_number() %% 20) %>% 
  group_by(simulN) %>%
  mutate(samp250 = if_else(row_number() <= 250, value, NA_real_),
         samp100 = if_else(row_number() <= 100, value, NA_real_),
         samp50 = if_else(row_number() <= 50, value, NA_real_),
         samp10 = if_else(row_number() <= 10, value, NA_real_)) %>%
  rename(samp500 = value) %>%
  ungroup() -> tmpTib

tmpTib %>%
  filter(simulN > 1 & simulN <= 5) %>%
  pivot_longer(cols = -simulN, names_to = "sample") %>%
  mutate(sample = ordered(sample,
                          levels = paste0("samp", c(500, 250, 100, 50, 10)))) -> tmpTibLong

ggplot(data = tmpTibLong,
       aes(y = value)) +
  geom_boxplot(fill = "grey", varwidth = TRUE, notch = TRUE) +
  geom_hline(yintercept = 0) +
  ylim(-4, 4) +
  facet_grid(cols = vars(sample),
             rows = vars(simulN)) +
  xlab("") +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) 

ggsave(filename = "notchedGaussianBoxes3.png",
       width = 1700,
       height = 1470,
       units = "px")
```

```{r notchedBoxplot2}
tibRawDat %>%
  group_by(Gender) %>%
  summarise(n = n(),
            median = median(Edad, na.rm = TRUE)) -> tmpTibSummary

ggplot(data = tibRawDat,
       aes(y = Edad, x = Gender, fill = Gender)) +
  geom_boxplot(varwidth = TRUE, notch = TRUE) +
  geom_text(data = tmpTibSummary,
            aes(x = Gender, y = 14, label = n),
            vjust = 0) +
  geom_text(x = .90, y = 14, label = "n: ",
            hjust = 1,
            vjust = 0) +
  geom_text(data = tmpTibSummary,
            aes(x = Gender, y = 11, label = median),
            vjust = 0,
            fontface = "plain") +
  geom_text(x = .9, y = 11, label = "median: ",
            hjust = 1,
            vjust = 0,
            fontface = "plain") +
  geom_hline(yintercept = median(tibRawDat$Edad, na.rm = TRUE)) +
  ylab("Age")

ggsave(filename = "AgeByGenderNotchedBox.png",
       width = 1700,
       height = 1470,
       units = "px")

tibRawDat %>%
  mutate(SocStatNA = if_else(is.na(SocState), "NA", SocState)) %>%
  group_by(SocStatNA) %>%
  summarise(tmpN = n(),
            tmpMedianAge = median(Edad, na.rm = TRUE),
            varAge = var(Edad, na.rm = TRUE),
            SDAge = sqrt(varAge)) -> tmpTib

tmpTib %>%
  arrange(desc(tmpN)) %>%
  select(SocStatNA) %>%
  pull() -> tmpVecN

tmpTib %>%
  arrange(tmpMedianAge) %>%
  select(SocStatNA) %>%
  pull() -> tmpVecAge


tibRawDat %>%
  mutate(SocStatNA = if_else(is.na(SocState), "NA", SocState),
         SocStatN = ordered(SocStatNA,
                            levels = tmpVecN,
                            labels = tmpVecN),
         SocStateAge = ordered(SocStatNA,
                               levels = tmpVecAge,
                               labels = tmpVecAge)) -> tibRawDat

ggplot(data = tibRawDat,
       aes(y = Edad, x = SocStatN, fill = SocStatN)) +
  geom_boxplot(varwidth = TRUE, notch = TRUE) +
  geom_hline(yintercept = median(tibRawDat$Edad, na.rm = TRUE)) +
  geom_text(data = tmpTib,
            inherit.aes = FALSE,
            aes(x = SocStatNA, y = 12, label = tmpN),
            vjust = .5) +
  geom_text(x = .5, y = 12, label = "n: ",
            vjust = .5,
            hjust = 0) +
  ylim(10, 80) +
  scale_fill_discrete(name = "Social status") +
  ylab("Age") +
  xlab("Social status") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))

ggsave(filename = "AgeBySocStatnNotchedBox.png",
       width = 1700,
       height = 1470,
       units = "px")

tibRawDat %>%
  filter(!is.na(meanCOREOM)) %>%
  group_by(SocStatN) %>%
  summarise(n = n(),
            median = round(median(meanCOREOM), 1)) -> tmpTibSummary

ggplot(data = tibRawDat,
       aes(y = meanCOREOM, x = SocStatN, fill = SocStatN)) +
  geom_boxplot(varwidth = TRUE, notch = TRUE) +
  geom_hline(yintercept = median(tibRawDat$meanCOREOM, na.rm = TRUE)) +
  geom_text(data = tmpTibSummary,
            inherit.aes = FALSE,
            aes(x = SocStatN, y = -.3, label = n),
            vjust = .5) +
  geom_text(x = .7, y = -.3, label = "n: ",
            vjust = .5,
            hjust = 1) +
  geom_text(data = tmpTibSummary,
            inherit.aes = FALSE,
            aes(x = SocStatN, y = -.5, label = median),
            vjust = .5) +
  geom_text(x = .7, y = -.5, label = "median: ",
            vjust = .5,
            hjust = 1) +  
  ylim(-.5, 4) +
  expand_limits(x = -.7) +
  scale_fill_discrete(name = "Social status") +
  ylab("CORE-OM score (mean item score)") +
  xlab("Social status") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))

ggsave(filename = "COREOMBySocStatnBox.png",
       width = 1700,
       height = 1470,
       units = "px")

tibRawDat %>%
  filter(!is.na(`Tiene Hijos`)) %>%
  mutate(nChildren = `Especifique cuántos`,
         nChildren = if_else(nChildren > 3, 4, nChildren),
         nChildren = if_else(`Tiene Hijos` == "NO", 0, nChildren),
         nChildren = ordered(nChildren,
                             levels = 0:4,
                             labels = c(as.character(0:3),
                                        "4 or more"))) %>%  
  filter(!is.na(nChildren)) -> tmpTib

ggplot(data = tmpTib,
       aes(y = Edad, x = nChildren, fill = nChildren)) +
  geom_boxplot(varwidth = TRUE) 

tmpTib %>%
  rowwise() %>%
  mutate(meanCOREOM = meanNotNA(c_across(COREOM01_01:COREOM01_34))) %>%
  ungroup() -> tmpTib

ggplot(data = tmpTib,
       aes(y = meanCOREOM, x = nChildren, fill = nChildren)) +
  geom_boxplot(varwidth = TRUE) 
```
